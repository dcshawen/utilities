#!/bin/bash

# Script: getignore
# Description: Downloads a specified .gitignore template from GitHub's official repository
#              or lists all available templates.
# Usage: getignore <TemplateName> | --append <TemplateName> | --list
# Example (Overwrite): getignore Python
# Example (Append):    getignore --append Node
# Example (List):      getignore --list

# --- Function: List Templates ---

# Lists all available templates by querying the GitHub API
list_templates() {
  echo "Fetching available .gitignore templates from github/gitignore..."

  local API_URL="https://api.github.com/repos/github/gitignore/git/trees/main?recursive=1"

  # Use a subshell with pipefail to ensure errors in any part of the pipe are caught
  (
    set -o pipefail

    # -s: Silent mode for curl
    # -L: Follow redirects
    # grep '"path"': Find lines with the "path" key
    # sed -E: Use extended regex to extract the path value
    # grep '\.gitignore$': Filter for files ending in .gitignore
    # sed 's/\.gitignore$//': Remove the .gitignore suffix
    # sort -f: Sort the final list case-insensitively
    curl -sL "$API_URL" |
      grep '"path":' |
      sed -E 's/.*"path": "([^"]+)".*/\1/' |
      grep '\.gitignore$' |
      sed 's/\.gitignore$//' |
      sort -f
  )

  # Check the exit status of the subshell
  if [ $? -ne 0 ]; then
    echo "Error: Failed to fetch or parse template list from GitHub API."
    echo "Please check your internet connection."
    exit 1
  fi
}

# --- Input Validation and Routing ---

# Mode 1: List templates
if [ "$1" == "--list" ]; then
  list_templates
  exit 0
fi

# Mode 2: Download (Append or Overwrite)
MODE="overwrite" # Default
if [ "$1" == "--append" ]; then
  MODE="append"
  shift # Remove --append, $1 is now the template name
fi

# Now, we should have exactly one argument left: the template name
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <TemplateName> | --append <TemplateName> | --list"
  echo "Example (Overwrite): $0 VisualStudio"
  echo "Example (Append):    $0 --append Node"
  echo "Example (List):      $0 --list"
  exit 1
fi

# Store the template name
TEMPLATE_NAME=$1

# --- Core Logic ---

# Base URL for the raw .gitignore files on GitHub
BASE_URL="https://raw.githubusercontent.com/github/gitignore/refs/heads/main/"

# Construct the full URL
# Note: This works for nested templates too, e.g., "Global/Vim"
FULL_URL="${BASE_URL}/${TEMPLATE_NAME}.gitignore"

CURL_EXIT_CODE=0

if [ "$MODE" == "append" ]; then
  echo "Appending template '$TEMPLATE_NAME' to .gitignore..."

  # Add a newline before appending, if the file exists and is not empty
  if [ -s .gitignore ]; then
    echo -e "\n" >>.gitignore
  fi

  # Append the new content
  # -f: Fail silently on server errors (e.g., 404)
  # -L: Follow redirects
  curl -fL "$FULL_URL" >>.gitignore
  CURL_EXIT_CODE=$?
else
  echo "Downloading (overwriting) template: $TEMPLATE_NAME..."

  # -f: Fail silently on server errors
  # -L: Follow redirects
  # -o: Specify output file (overwrites)
  curl -fL "$FULL_URL" -o .gitignore
  CURL_EXIT_CODE=$?
fi

# --- Result Check ---

if [ $CURL_EXIT_CODE -eq 0 ]; then
  if [ "$MODE" == "append" ]; then
    echo "Success: Appended $TEMPLATE_NAME template to .gitignore"
  else
    echo "Success: Downloaded $TEMPLATE_NAME and saved as .gitignore"
  fi
else
  echo "Error: Failed to download the template (Code: $CURL_EXIT_CODE)."
  echo "Note: Ensure the template name is correct (e.g., Python, Global/VisualStudio)."
  echo "Tip: Run '$0 --list' to see all available templates."

  # IMPORTANT: Only remove .gitignore if we were in 'overwrite' mode
  # Do not destroy the original file if an append fails.
  if [ "$MODE" == "overwrite" ]; then
    # Clean up potential empty or corrupted output file
    if [ -f .gitignore ]; then
      rm .gitignore
    fi
  fi
  exit 1
fi

exit 0
